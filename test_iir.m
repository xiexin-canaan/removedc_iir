clear;clc;close all;
Fs = 48e3;  % sampling frequency
Len = 10000;% sampling points of wave
Amp = 1;    % amplify of sin/cos wave
mex -v -g dc_iir_fxp_c.c
WLen = 16;  % 乘法器，寄存器位宽
%% Fstop=30,Fpass=150,Astop=60,Apass=0.01
% SOS = [1,-2,1,1,-1.99523925781250,0.995300292968750;...
%     1,-2,1,1,-1.98681640625000,0.986938476562500;...
%     1,-2,1,1,-1.98107910156250,0.981201171875000;...
%     1,-1,0,1,-0.989501953125000,0];
% G = [0.997619628906250/2;0.993438720703125;0.990570068359375;0.994750976562500;1*2];
% G = [0.997619628906250;0.993438720703125;0.990570068359375;0.994750976562500;1];% 原始的gain
%% Fstop=20,Fpass=100,Astop=80,Apass=0.01
% SOS = [1,-2,1,1,-1.99670410156250,0.996765136718750;...
%     1,-2,1,1,-1.99078369140625,0.990844726562500;...
%     1,-2,1,1,-1.98626708984375,0.986328125000000;...
%     1,-2,1,1,-1.98382568359375,0.983886718750000];
% G = [0.998382568359375/2;0.995391845703125;0.993133544921875;0.991943359375000;1*2];
% % G = [0.998382568359375;0.995391845703125;0.993133544921875;0.991943359375000;1];% 原始的gain
%% Fstop=50,Fpass=100,Astop=80,Apass=0.01,Elliptic
SOS = [1,-1.99993896484375,1,1,-1.99774169921875,0.997863769531250;...
    1,-1.99993896484375,1,1,-1.99145507812500,0.991638183593750;...
    1,-2,1,1,-1.97668457031250,0.976989746093750;...
    1,-1,0,1,-0.979125976562500,0];
G = [0.620239257812500/2;0.995788574218750;0.988403320312500;1.59375000000000;1*2];
% G = [0.620239257812500;0.995788574218750;0.988403320312500;1.59375000000000;1];% 原始的gain
%% filter_dc_notch16
% SOS = [1,-2,1,1,-1.9640,0.9646];
% G = [0.982*0.9;1/0.9];
% % G = [0.982;1]; % 原始的gain

for freq=0:100:Fs/10
    x = Amp*cos(2*pi*freq*(0:Len-1)/Fs);
    x = double(fi(x,1,16,15));%Q(16,15)
    [yFlt]=dc_iir(x, SOS, G);
    [yCFxp]=dc_iir_fxp(x, SOS, G,'c',WLen);
%     [yMFxp]=dc_iir_fxp(x, SOS, G,'matlab',WLen);
    plot(yFlt);hold on;plot(yCFxp);hold off;legend('flt','fxpC');
    MSEFxp2Flt = 10*log10(sum(abs(yCFxp-yFlt).^2)/Len);
%     plot(yFlt);hold on;plot(yCFxp);plot(yMFxp);hold off;legend('flt','fxpC','fxpM');
    gainFlt = 10*log10(sum(abs(yFlt(3000:end)).^2)/sum(abs(x(3000:end)).^2));
    gainFxp = 10*log10(sum(abs(yCFxp(3000:end)).^2)/sum(abs(x(3000:end)).^2));
    fprintf('freq=%dHz,QuantError=%.2fdB,gainFxp=%.2fdB,gainFlt=%.2fdB\n',freq,MSEFxp2Flt,gainFxp,gainFlt);
end